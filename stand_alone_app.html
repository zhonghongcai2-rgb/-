
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>社区协同管理平台 5.0 (独立版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react/dist/lucide-react.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
      body { font-family: 'Noto Sans SC', sans-serif; background-color: #f3f4f6; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
      .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
      .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
      .animate-fade-in-down { animation: fadeInDown 0.2s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { AreaChart, Area, CartesianGrid, Tooltip, Legend, ResponsiveContainer, XAxis, YAxis, BarChart, Bar } = Recharts;
        const { 
            LayoutDashboard, Users, FileCheck, Store, ClipboardList, Truck, Wallet, 
            CreditCard, Settings, Database, Building, BookOpen, Briefcase, Percent,
            Package, FileText, CheckCircle, XCircle, TrendingUp, TrendingDown, ShieldAlert,
            UserPlus, MousePointer, Box, RotateCcw, Filter, Search, Loader2,
            Edit, Plus, Trash2, ChevronLeft, ChevronRight, Eye, Download,
            AlertTriangle, User, MapPin, X, Bell, Check, Info, BellOff,
            Upload, Folder, LayoutGrid, Clock, ShieldCheck, Lock, Command, Menu, ChevronDown, LogOut
        } = LucideReact;

        // ==========================================
        // 1. CONSTANTS & TYPES
        // ==========================================
        
        const Role = {
          KUAIJIN: 'KUAIJIN',           
          PROVIDER: 'SERVICE_PROVIDER', 
          PARTNER: 'PARTNER',           
          PROPERTY: 'PROPERTY',         
          STATION: 'STATION',           
          COURIER: 'COURIER',           
        };

        const MENU_ITEMS = [
          { id: 'dashboard', label: '首页', icon: LayoutDashboard, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY, Role.STATION] },
          { id: 'data', label: '数据报表', icon: Database, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY], children: [
            { id: 'data-reports', label: '报表', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY] }
          ]},
          { id: 'provider', label: '服务商管理', icon: Briefcase, roles: [Role.KUAIJIN], children: [
            { id: 'provider-list', label: '服务商列表', icon: null, roles: [Role.KUAIJIN] }
          ]},
          { id: 'partner', label: '合伙人管理', icon: Users, roles: [Role.KUAIJIN, Role.PROVIDER], children: [
            { id: 'partner-list', label: '合伙人列表', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER] } 
          ]},
          { id: 'property', label: '物业公司管理', icon: Building, roles: [Role.KUAIJIN, Role.PROVIDER] }, 
          { id: 'station', label: '服务站管理', icon: Store, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY] },
          { id: 'audit', label: '审核管理', icon: FileCheck, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.STATION], children: [
              { id: 'audit-station-action', label: '服务站审核', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER] },
              { id: 'audit-station-query', label: '服务站审核进度查询', icon: null, roles: [Role.PARTNER] },
              { id: 'audit-partner-action', label: '合伙人审核', icon: null, roles: [Role.KUAIJIN] },
              { id: 'audit-partner-query', label: '合伙人审核进度查询', icon: null, roles: [Role.PROVIDER] }, 
              { id: 'audit-property-action', label: '物业公司审核', icon: null, roles: [Role.KUAIJIN] }, 
              { id: 'audit-property-query', label: '物业公司审核进度查询', icon: null, roles: [Role.PROVIDER] },
          ]}, 
          { id: 'ticket', label: '工单管理', icon: ClipboardList, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER] },
          { id: 'express', label: '快递管理', icon: Truck, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY], children: [
            { id: 'express-package', label: '包裹管理', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY] },
            { id: 'express-archive', label: '归档管理', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY] }
          ]},
          { id: 'finance', label: '财务管理', icon: Wallet, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY], children: [
            { id: 'finance-trans', label: '交易明细', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER] }, 
            { id: 'finance-bill', label: '收益账单', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.PROPERTY] },
            { id: 'split-settings', label: '分账设置', icon: Percent, roles: [Role.KUAIJIN] }
          ]},
          { id: 'payment', label: '支付管理', icon: CreditCard, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER] },
          { id: 'help', label: '帮助中心', icon: BookOpen, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.STATION, Role.PROPERTY], children: [
              { id: 'help-docs', label: '帮助文档', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER, Role.STATION, Role.PROPERTY] }
          ]},
          { id: 'system', label: '系统管理', icon: Settings, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER], children: [
            { id: 'system-role', label: '角色管理', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER] },
            { id: 'system-user', label: '用户管理', icon: null, roles: [Role.KUAIJIN, Role.PROVIDER, Role.PARTNER] }
          ]}
        ];

        const CASCADER_REGIONS = {
            '浙江省': { '杭州市': ['西湖区', '上城区', '滨江区', '余杭区'], '宁波市': ['海曙区', '江北区', '镇海区'] },
            '江苏省': { '南京市': ['玄武区', '秦淮区'], '苏州市': ['姑苏区', '虎丘区'] }
        };

        const EXPRESS_BRANDS = ['顺丰速运', '圆通速递', '中通快递', '申通快递', '韵达快递', '极兔速递', '邮政EMS', '京东物流'];

        const MOCK_PROVIDERS = [
            { id: 'sp001', name: '深圳市快金数据', address: '华强科技广场', contact: '寇鑫', phone: '18618162830', partnerCount: 1, balance: 500000, status: 'active', region: '广东省深圳市' },
            { id: 'sp002', name: '翟总', address: '深圳南山区', contact: '翟总', phone: '13428796300', partnerCount: 1, balance: 10000, status: 'active', region: '广东省深圳市' },
            { id: 'sp003', name: 'KDN服务商', address: '福田区', contact: '研发测试', phone: '15010102301', partnerCount: 1, balance: 2000, status: 'active', region: '广东省深圳市' },
        ];

        const MOCK_PARTNERS = [
          { id: 'p001', name: '快递鸟', providerName: '深圳市快金数据', contactPerson: '寇鑫', phone: '18618162830', stationCount: 1, status: 'active' },
          { id: 'p002', name: '翟总', providerName: '翟总', contactPerson: '翟总', phone: '13428796300', stationCount: 4, status: 'active' },
          { id: 'p003', name: 'KDN合伙人', providerName: 'KDN测试服务商', contactPerson: 'KDN测试001', phone: '15014042029', stationCount: 7, status: 'active' },
        ];

        const MOCK_PROPERTIES = [
          { id: 'prop001', name: '深圳市澎柏物业管理有限公司‌', contact: '翟总', phone: '19007560872', stationCount: 4, providerName: '翟总', createTime: '2025-11-02' },
          { id: 'prop002', name: '碧桂园物业公司', contact: '王鑫', phone: '18104445320', stationCount: 4, providerName: '深圳市快金数据', createTime: '2025-09-03' },
          { id: 'prop003', name: '快递鸟公司', contact: '李总', phone: '15815746335', stationCount: 5, providerName: 'KDN服务商', createTime: '2025-08-28' },
        ];

        const MOCK_STATIONS = [
          { id: 's001', name: '厚德品园上门服务', partnerName: '翟总', propertyName: '深圳市澎柏物业管理有限公司‌', account: '18618162830', region: '广东省深圳市', status: 'normal', balance: 3000 },
          { id: 's002', name: '锦隆花园上门服务', partnerName: '翟总', propertyName: '深圳市澎柏物业管理有限公司‌', account: '13510221470', region: '广东省深圳市', status: 'normal', balance: 1000 },
          { id: 's003', name: '嘉铭D区上门', partnerName: 'KDN合伙人', propertyName: '快递鸟公司', account: '15369803719', region: '广东省深圳市', status: 'normal', balance: 20000 },
        ];

        const MOCK_AUDITS = [
          { id: 'a001', stationName: '未来科技城服务站', account: 'YZ_APPLY_001', phone: '15011112222', region: '杭州市余杭区', partnerName: '快递鸟', providerName: '深圳市快金数据', propertyName: '绿城物业公司', status: 'pending', applyTime: '2023-10-25 10:00' }
        ];

        const MOCK_SYSTEM_USERS = [
            { id: 'u001', username: 'admin', phone: '13800000000', roleName: '超级管理员', status: 'active', organization: '平台总部', walletBalance: 10000, password: '123456a' },
            { id: 'u002', username: 'provider_01', phone: '13900000001', roleName: '服务商', status: 'active', organization: '杭州顺达服务商', walletBalance: 500000, password: '123456a' },
        ];

        const MOCK_FINANCE = [
          { id: 'TRX001', date: '2023-10-26', type: '派费收入', amount: 0.80, subject: '幸福小区服务站', status: 'success' },
          { id: 'TRX002', date: '2023-10-26', type: '短信费', amount: -0.05, subject: '幸福小区服务站', status: 'success' },
        ];

        const MOCK_BILLS = [
            { id: 'BILL202309001', month: '2023-09', accountType: 'station', name: '幸福小区服务站', stationName: '厚德品园上门服务', amount: 3450.00, status: 'confirmed' },
        ];

        const MOCK_REPORTS = [
            { id: 'rep001', name: '厚德品园上门服务', type: 'station', province: '广东省', city: '深圳市', district: '南山区', totalInbound: 120, totalOutbound: 80, issueCount: 2 },
        ];
        
        const MOCK_SPLIT_CONFIGS = [
            { id: 'sc001', entityName: '深圳市快金数据', entityType: 'provider', walletAccount: 'SP_WALLET_001', ratio: 5.0, status: 'active', updateTime: '2023-10-01' },
            { id: 'sc005', entityName: '深圳市澎柏物业管理有限公司‌', entityType: 'property', walletAccount: 'PROP_WALLET_001', ratio: 10.0, providerRatio: 15.0, status: 'active', updateTime: '2023-10-05' },
        ];

        // ==========================================
        // 2. COMMON COMPONENTS & MODALS
        // ==========================================

        const GenericModal = ({ isOpen, onClose, title, children, footer, size = 'md' }) => {
          if (!isOpen) return null;
          const sizeClasses = { sm: 'max-w-md', md: 'max-w-lg', lg: 'max-w-2xl', xl: 'max-w-6xl' };
          return (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4 z-50">
              <div className={`bg-white rounded-lg shadow-xl w-full ${sizeClasses[size]} flex flex-col max-h-[90vh]`}>
                <div className="flex justify-between items-center px-6 py-4 border-b">
                    <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5" /></button>
                </div>
                <div className="p-6 overflow-y-auto flex-1 custom-scrollbar">{children}</div>
                {footer && <div className="px-6 py-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-2">{footer}</div>}
              </div>
            </div>
          );
        };

        const HorizontalInputGroup = ({ label, required, children }) => (
          <div className="flex items-center mb-4">
            <label className="w-[120px] text-right text-sm text-gray-600 pr-3 font-medium flex-shrink-0">
              {required && <span className="text-red-500 mr-1">*</span>}{label}
            </label>
            <div className="flex-1">{children}</div>
          </div>
        );

        const ServiceProviderModal = ({ isOpen, onClose, onSubmit }) => {
            const [name, setName] = useState('');
            return (
                <GenericModal isOpen={isOpen} onClose={onClose} title="添加服务商" footer={<><button onClick={onClose} className="px-4 py-2 border rounded mr-2">取消</button><button onClick={() => { onSubmit({name}); onClose(); }} className="px-4 py-2 bg-blue-600 text-white rounded">确定</button></>}>
                    <HorizontalInputGroup label="服务商名称" required><input className="border p-2 w-full rounded" value={name} onChange={e => setName(e.target.value)} /></HorizontalInputGroup>
                </GenericModal>
            )
        };
        
        const PartnerModal = ({ isOpen, onClose, onSubmit, initialData }) => {
             const [name, setName] = useState('');
             return (
                <GenericModal isOpen={isOpen} onClose={onClose} title="合伙人信息" footer={<><button onClick={onClose} className="px-4 py-2 border rounded mr-2">取消</button><button onClick={() => { onSubmit({name}); onClose(); }} className="px-4 py-2 bg-blue-600 text-white rounded">确定</button></>}>
                    <HorizontalInputGroup label="合伙人名称" required><input className="border p-2 w-full rounded" value={name} onChange={e => setName(e.target.value)} /></HorizontalInputGroup>
                </GenericModal>
             )
        }

        const UserModal = ({ isOpen, onClose, initialData, currentUserRole, currentUserOrg }) => {
            const [username, setUsername] = useState('');
            const [org, setOrg] = useState('');
            const [role, setRole] = useState('服务商');
            
            useEffect(() => {
                if(isOpen && !initialData && currentUserRole !== Role.KUAIJIN) {
                    setOrg(currentUserOrg); // Auto-lock organization for non-admin
                }
            }, [isOpen]);

            return (
                <GenericModal isOpen={isOpen} onClose={onClose} title="用户信息" footer={<><button onClick={onClose} className="px-4 py-2 border rounded mr-2">取消</button><button onClick={() => { onClose(); alert('保存成功'); }} className="px-4 py-2 bg-blue-600 text-white rounded">保存</button></>}>
                    <HorizontalInputGroup label="用户名" required><input className="border p-2 w-full rounded" value={username} onChange={e => setUsername(e.target.value)} /></HorizontalInputGroup>
                    <HorizontalInputGroup label="归属组织">
                        <input className="border p-2 w-full rounded bg-gray-100" value={org} onChange={e => setOrg(e.target.value)} disabled={currentUserRole !== Role.KUAIJIN} />
                    </HorizontalInputGroup>
                </GenericModal>
            )
        }

        // ==========================================
        // 3. MAIN VIEWS (MANAGERS)
        // ==========================================

        const ServiceProviderManager = ({ userRole, userOrg }) => {
            // Strict Isolation: Only Kuaijin sees all, Provider sees self
            const list = userRole === Role.KUAIJIN ? MOCK_PROVIDERS : userRole === Role.PROVIDER ? MOCK_PROVIDERS.filter(p => p.name === userOrg) : [];
            const [modalOpen, setModalOpen] = useState(false);
            
            return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="flex justify-between mb-4">
                        {userRole === Role.KUAIJIN && <button onClick={() => setModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded text-sm flex items-center gap-1"><Plus className="w-4 h-4"/> 新增服务商</button>}
                        <div className="text-gray-500 text-sm">共 {list.length} 条数据</div>
                    </div>
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">名称</th><th className="p-3">负责人</th><th className="p-3">余额</th><th className="p-3">状态</th></tr></thead>
                            <tbody>
                                {list.map(p => <tr key={p.id} className="border-b hover:bg-gray-50"><td className="p-3">{p.name}</td><td className="p-3">{p.contact}</td><td className="p-3">{p.balance}</td><td className="p-3"><span className="text-green-600 bg-green-50 px-2 py-1 rounded text-xs">{p.status}</span></td></tr>)}
                            </tbody>
                        </table>
                    </div>
                    <ServiceProviderModal isOpen={modalOpen} onClose={() => setModalOpen(false)} onSubmit={() => {}} />
                </div>
            );
        };

        const PartnerManager = ({ userRole, userOrg }) => {
             // Strict Isolation
             let list = [];
             if (userRole === Role.KUAIJIN) list = MOCK_PARTNERS;
             else if (userRole === Role.PROVIDER) list = MOCK_PARTNERS.filter(p => p.providerName === userOrg);
             else if (userRole === Role.PARTNER) list = MOCK_PARTNERS.filter(p => p.name === userOrg);

             return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="flex justify-between mb-4">
                        {userRole !== Role.PARTNER && <button className="bg-blue-600 text-white px-4 py-2 rounded text-sm flex items-center gap-1"><Plus className="w-4 h-4"/> 新增合伙人</button>}
                    </div>
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">合伙人名称</th><th className="p-3">所属服务商</th><th className="p-3">服务站数</th><th className="p-3">状态</th></tr></thead>
                            <tbody>
                                {list.map(p => <tr key={p.id} className="border-b hover:bg-gray-50"><td className="p-3">{p.name}</td><td className="p-3">{p.providerName}</td><td className="p-3">{p.stationCount}</td><td className="p-3"><span className="text-green-600 bg-green-50 px-2 py-1 rounded text-xs">正常</span></td></tr>)}
                            </tbody>
                        </table>
                    </div>
                </div>
             );
        };

        const PropertyManager = ({ userRole, userOrg }) => {
             let list = [];
             if (userRole === Role.KUAIJIN) list = MOCK_PROPERTIES;
             else if (userRole === Role.PROVIDER) list = MOCK_PROPERTIES.filter(p => p.providerName === userOrg);
             else if (userRole === Role.PROPERTY) list = MOCK_PROPERTIES.filter(p => p.name === userOrg);

             return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">物业名称</th><th className="p-3">所属服务商</th><th className="p-3">服务站数</th><th className="p-3">联系人</th></tr></thead>
                            <tbody>
                                {list.map(p => <tr key={p.id} className="border-b hover:bg-gray-50"><td className="p-3">{p.name}</td><td className="p-3">{p.providerName}</td><td className="p-3">{p.stationCount}</td><td className="p-3">{p.contact}</td></tr>)}
                            </tbody>
                        </table>
                    </div>
                </div>
             );
        };

        const StationManager = ({ userRole, userOrg }) => {
             let list = [];
             if (userRole === Role.KUAIJIN) list = MOCK_STATIONS;
             else if (userRole === Role.PROVIDER) {
                 const myPartners = MOCK_PARTNERS.filter(p => p.providerName === userOrg).map(p => p.name);
                 const myProps = MOCK_PROPERTIES.filter(p => p.providerName === userOrg).map(p => p.name);
                 list = MOCK_STATIONS.filter(s => myPartners.includes(s.partnerName) || myProps.includes(s.propertyName));
             }
             else if (userRole === Role.PARTNER) list = MOCK_STATIONS.filter(s => s.partnerName === userOrg);
             else if (userRole === Role.PROPERTY) list = MOCK_STATIONS.filter(s => s.propertyName === userOrg);

             return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">服务站名称</th><th className="p-3">合伙人</th><th className="p-3">物业</th><th className="p-3">余额</th></tr></thead>
                            <tbody>
                                {list.map(s => <tr key={s.id} className="border-b hover:bg-gray-50"><td className="p-3">{s.name}</td><td className="p-3">{s.partnerName}</td><td className="p-3">{s.propertyName}</td><td className="p-3 text-orange-600 font-bold">¥{s.balance}</td></tr>)}
                            </tbody>
                        </table>
                    </div>
                </div>
             );
        };

        const FinanceTransactionManager = () => {
             return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="mb-4 font-bold text-gray-700">交易流水明细 (只读)</div>
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">日期</th><th className="p-3">类型</th><th className="p-3">金额</th><th className="p-3">状态</th></tr></thead>
                            <tbody>
                                {MOCK_FINANCE.map(f => <tr key={f.id} className="border-b hover:bg-gray-50"><td className="p-3">{f.date}</td><td className="p-3">{f.type}</td><td className={`p-3 font-bold ${f.amount > 0 ? 'text-green-600' : 'text-red-600'}`}>{f.amount}</td><td className="p-3">成功</td></tr>)}
                            </tbody>
                        </table>
                    </div>
                </div>
             );
        };

        const FinanceBillManager = ({ userRole, userOrg }) => {
             let list = [];
             if (userRole === Role.KUAIJIN) list = MOCK_BILLS;
             else if (userRole === Role.PROPERTY) {
                 const myStations = MOCK_STATIONS.filter(s => s.propertyName === userOrg).map(s => s.name);
                 list = MOCK_BILLS.filter(b => myStations.includes(b.stationName));
             } else {
                 list = MOCK_BILLS; 
             }

             return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="mb-4 font-bold text-gray-700">收益账单</div>
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">账期</th><th className="p-3">服务站</th><th className="p-3">金额</th><th className="p-3">状态</th></tr></thead>
                            <tbody>
                                {list.length > 0 ? list.map(b => <tr key={b.id} className="border-b hover:bg-gray-50"><td className="p-3">{b.month}</td><td className="p-3">{b.stationName}</td><td className="p-3 text-blue-600 font-bold">¥{b.amount}</td><td className="p-3">{b.status}</td></tr>) : <tr><td colSpan={4} className="p-4 text-center text-gray-400">暂无数据</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
             );
        };

        const SystemUserManager = ({ userRole, userOrg }) => {
            const list = MOCK_SYSTEM_USERS.filter(u => userRole === Role.KUAIJIN ? true : u.organization === userOrg);
            const [modalOpen, setModalOpen] = useState(false);
            
            return (
                <div className="bg-white p-6 rounded shadow h-full flex flex-col">
                    <div className="flex justify-between mb-4">
                        <button onClick={() => setModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded text-sm flex items-center gap-1"><Plus className="w-4 h-4"/> 新增用户</button>
                    </div>
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-700 font-semibold"><tr><th className="p-3">用户名</th><th className="p-3">组织</th><th className="p-3">角色</th><th className="p-3">状态</th></tr></thead>
                            <tbody>
                                {list.map(u => <tr key={u.id} className="border-b hover:bg-gray-50"><td className="p-3">{u.username}</td><td className="p-3">{u.organization}</td><td className="p-3">{u.roleName}</td><td className="p-3"><span className="text-green-600">正常</span></td></tr>)}
                            </tbody>
                        </table>
                    </div>
                    <UserModal isOpen={modalOpen} onClose={() => setModalOpen(false)} currentUserRole={userRole} currentUserOrg={userOrg} />
                </div>
            );
        };

        // ==========================================
        // 4. LOGIN COMPONENT
        // ==========================================

        const Login = ({ onLogin }) => {
            const [username, setUsername] = useState('provider_01');
            const [password, setPassword] = useState('123456a');
            const [selectedRole, setSelectedRole] = useState(Role.PROVIDER);
            
            const handleDemoRoleSelect = (role) => {
                setSelectedRole(role);
                setUsername('admin');
                setPassword('123456a');
            };

            const handleLogin = (e) => {
                e.preventDefault();
                setTimeout(() => {
                    const foundUser = MOCK_SYSTEM_USERS.find(u => u.username === username);
                    const isDemo = username === 'admin' && selectedRole !== Role.KUAIJIN;

                    if (foundUser && !isDemo) {
                        let role = Role.KUAIJIN;
                        if (foundUser.roleName.includes('服务商')) role = Role.PROVIDER;
                        onLogin({ name: foundUser.username, role: role, organization: foundUser.organization });
                    } else {
                        let org = '平台总部';
                        if (selectedRole === Role.PROVIDER) org = '深圳市快金数据';
                        else if (selectedRole === Role.PARTNER) org = '快递鸟';
                        else if (selectedRole === Role.PROPERTY) org = '深圳市澎柏物业管理有限公司‌';
                        else if (selectedRole === Role.STATION) org = '厚德品园上门服务';

                        onLogin({ name: isDemo ? '演示用户' : username, role: selectedRole, organization: org });
                    }
                }, 500);
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                        <h2 className="text-2xl font-bold text-center mb-6">系统登录</h2>
                        <div className="bg-blue-50 p-4 rounded mb-6">
                            <p className="text-xs font-bold text-blue-600 mb-2">演示视角切换:</p>
                            <div className="flex gap-2">
                                {[Role.PROVIDER, Role.PARTNER, Role.PROPERTY].map(r => (
                                    <button key={r} type="button" onClick={() => handleDemoRoleSelect(r)} className={`px-2 py-1 text-xs rounded border ${selectedRole === r ? 'bg-blue-600 text-white' : 'bg-white'}`}>
                                        {r === Role.PROVIDER ? '服务商' : r === Role.PARTNER ? '合伙人' : '物业'}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" value={username} onChange={e => setUsername(e.target.value)} className="w-full border p-3 rounded" placeholder="账号" />
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full border p-3 rounded" placeholder="密码" />
                            <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">登录</button>
                        </form>
                    </div>
                </div>
            )
        }

        // ==========================================
        // 5. DASHBOARD COMPONENT
        // ==========================================
        
        const StatCard = ({ title, value, icon: Icon, colorClass }) => (
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-full">
                <div className="flex justify-between items-start mb-2"><div className={`p-2 rounded-lg ${colorClass} bg-opacity-10`}><Icon className={`w-5 h-5 ${colorClass.replace('bg-', 'text-')}`} /></div></div>
                <div><h4 className="text-2xl font-bold text-gray-800">{value}</h4><p className="text-xs text-gray-500 mt-1">{title}</p></div>
            </div>
        );

        const SectionTitle = ({ title, children }) => (
            <div className="flex items-center justify-between mb-4 mt-8">
                <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <div className="w-1 h-5 bg-blue-600 rounded-full"></div>
                    {title}
                </h3>
                {children}
            </div>
        );

        const Dashboard = ({ userRole }) => {
            const [viewMode, setViewMode] = useState(() => {
                if (userRole === Role.PARTNER) return 'station';
                if (userRole === Role.PROPERTY) return 'station';
                if (userRole === Role.STATION) return 'station';
                return 'property';
            });
            const [selectedEntity, setSelectedEntity] = useState('');
            const [selectedProvince, setSelectedProvince] = useState('');
            const [selectedCity, setSelectedCity] = useState('');
            
            const [trendData, setTrendData] = useState([
                { time: '08:00', inbound: 120, outbound: 80 },
                { time: '10:00', inbound: 300, outbound: 240 },
                { time: '12:00', inbound: 200, outbound: 450 },
                { time: '14:00', inbound: 278, outbound: 200 },
                { time: '16:00', inbound: 489, outbound: 380 },
                { time: '18:00', inbound: 340, outbound: 430 },
                { time: '20:00', inbound: 150, outbound: 210 },
            ]);

            const filterOptions = {
                property: ['所有物业公司', ...MOCK_PROPERTIES.map(p => p.name)],
                partner: ['所有合伙人', ...MOCK_PARTNERS.map(p => p.name)],
                station: ['所有服务站', ...MOCK_STATIONS.map(s => s.name)],
            };

            return (
                <div className="p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">总览看板</h2>
                    
                    {/* Filter Section */}
                    <div className="bg-white p-4 rounded-xl border mb-6 flex flex-wrap gap-4 items-center">
                        <div className="flex items-center gap-2 text-sm font-bold text-gray-700"><Filter className="w-4 h-4"/> 筛选:</div>
                        
                        {(userRole === Role.KUAIJIN || userRole === Role.PROVIDER) && (
                            <div className="flex bg-gray-100 p-1 rounded">
                                <button onClick={() => setViewMode('property')} className={`px-2 py-1 text-xs rounded ${viewMode === 'property' ? 'bg-white shadow' : ''}`}>物业</button>
                                <button onClick={() => setViewMode('partner')} className={`px-2 py-1 text-xs rounded ${viewMode === 'partner' ? 'bg-white shadow' : ''}`}>合伙人</button>
                                <button onClick={() => setViewMode('station')} className={`px-2 py-1 text-xs rounded ${viewMode === 'station' ? 'bg-white shadow' : ''}`}>服务站</button>
                            </div>
                        )}

                        {/* Entity Select - Hidden for Property Role */}
                        {userRole !== Role.PROPERTY && (
                            <select className="border rounded p-1 text-sm min-w-[120px]" value={selectedEntity} onChange={e => setSelectedEntity(e.target.value)}>
                                <option value="">选择实体</option>
                                {filterOptions[viewMode]?.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        )}

                        <div className="flex gap-2">
                            <select className="border rounded p-1 text-sm" value={selectedProvince} onChange={e => setSelectedProvince(e.target.value)}>
                                <option value="">省份</option>
                                {Object.keys(CASCADER_REGIONS).map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                            {selectedProvince && (
                                <select className="border rounded p-1 text-sm" value={selectedCity} onChange={e => setSelectedCity(e.target.value)}>
                                    <option value="">城市</option>
                                    {Object.keys(CASCADER_REGIONS[selectedProvince]).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <StatCard title="入库包裹" value="12,543" icon={Package} colorClass="bg-blue-500" />
                        <StatCard title="出库包裹" value="8,234" icon={Truck} colorClass="bg-green-500" />
                        <StatCard title="滞留库存" value="4,309" icon={Box} colorClass="bg-orange-500" />
                        <StatCard title="预估收益" value="¥4,520" icon={Wallet} colorClass="bg-purple-500" />
                    </div>

                    {/* Charts Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <SectionTitle title="包裹流量趋势"></SectionTitle>
                            <div className="h-80">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={trendData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                                        <defs>
                                            <linearGradient id="colorIn" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.1}/>
                                                <stop offset="95%" stopColor="#3B82F6" stopOpacity={0}/>
                                            </linearGradient>
                                            <linearGradient id="colorOut" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#10B981" stopOpacity={0.1}/>
                                                <stop offset="95%" stopColor="#10B981" stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <XAxis dataKey="time" axisLine={false} tickLine={false} tick={{fontSize: 12, fill: '#9CA3AF'}} />
                                        <YAxis axisLine={false} tickLine={false} tick={{fontSize: 12, fill: '#9CA3AF'}} />
                                        <CartesianGrid vertical={false} stroke="#E5E7EB" strokeDasharray="3 3" />
                                        <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }} />
                                        <Legend iconType="circle" />
                                        <Area type="monotone" dataKey="inbound" name="入库量" stroke="#3B82F6" strokeWidth={2} fillOpacity={1} fill="url(#colorIn)" />
                                        <Area type="monotone" dataKey="outbound" name="出库量" stroke="#10B981" strokeWidth={2} fillOpacity={1} fill="url(#colorOut)" />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <SectionTitle title="品牌入库占比">
                                <span className="text-xs text-gray-400">TOP 5</span>
                            </SectionTitle>
                            <div className="space-y-4">
                                {[
                                    { name: '中通快递', value: 35, color: 'bg-blue-500' },
                                    { name: '圆通速递', value: 25, color: 'bg-purple-500' },
                                    { name: '韵达快递', value: 20, color: 'bg-yellow-500' },
                                    { name: '极兔速递', value: 15, color: 'bg-red-500' },
                                    { name: '顺丰速运', value: 5, color: 'bg-green-500' },
                                ].map(brand => (
                                    <div key={brand.name}>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-gray-600">{brand.name}</span>
                                            <span className="font-bold text-gray-800">{brand.value}%</span>
                                        </div>
                                        <div className="w-full bg-gray-100 rounded-full h-2">
                                            <div className={`h-2 rounded-full ${brand.color}`} style={{ width: `${brand.value}%` }}></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        // ==========================================
        // 6. APP SHELL
        // ==========================================

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [activeMenu, setActiveMenu] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);

            useEffect(() => {
                const handleHash = () => setActiveMenu(window.location.hash.slice(1) || 'dashboard');
                window.addEventListener('hashchange', handleHash);
                return () => window.removeEventListener('hashchange', handleHash);
            }, []);

            if (!isLoggedIn) return <Login onLogin={(u) => { setUser(u); setIsLoggedIn(true); }} />;

            const renderContent = () => {
                const props = { userRole: user.role, userOrg: user.organization };
                switch(activeMenu) {
                    case 'dashboard': return <Dashboard {...props} />;
                    case 'provider-list': return <ServiceProviderManager {...props} />;
                    case 'partner-list': return <PartnerManager {...props} />;
                    case 'property': return <PropertyManager {...props} />;
                    case 'station': return <StationManager {...props} />;
                    case 'finance-trans': return <FinanceTransactionManager {...props} />;
                    case 'finance-bill': return <FinanceBillManager {...props} />;
                    case 'system-user': return <SystemUserManager {...props} />;
                    default: return <div className="p-10 text-center text-gray-400">功能开发中... ({activeMenu})</div>
                }
            }

            return (
                <div className="flex h-screen bg-gray-50 overflow-hidden">
                    <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-slate-900 text-gray-300 flex flex-col transition-all duration-300 shadow-xl`}>
                        <div className="h-16 flex items-center justify-center font-bold text-white text-xl">M</div>
                        <nav className="flex-1 overflow-y-auto py-4">
                            <ul className="space-y-1 px-3">
                                {MENU_ITEMS.map(item => {
                                    if (!item.roles.includes(user.role)) return null;
                                    const Icon = item.icon;
                                    return (
                                        <li key={item.id}>
                                            <div onClick={() => window.location.hash = item.id} className={`flex items-center gap-3 px-3 py-2 rounded cursor-pointer ${activeMenu === item.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-800'}`}>
                                                {Icon && <Icon className="w-5 h-5" />}
                                                {isSidebarOpen && <span>{item.label}</span>}
                                            </div>
                                            {isSidebarOpen && item.children && (
                                                <div className="ml-8 mt-1 space-y-1">
                                                    {item.children.map(child => {
                                                        if (!child.roles.includes(user.role)) return null;
                                                        return <div key={child.id} onClick={() => window.location.hash = child.id} className="text-sm cursor-pointer hover:text-white py-1">{child.label}</div>
                                                    })}
                                                </div>
                                            )}
                                        </li>
                                    );
                                })}
                            </ul>
                        </nav>
                    </aside>
                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm z-10">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)}><Menu className="w-5 h-5 text-gray-600" /></button>
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <div className="text-sm font-bold text-gray-800">{user.name}</div>
                                    <div className="text-xs text-gray-500">{user.organization || '无组织'}</div>
                                </div>
                                <button onClick={() => setIsLoggedIn(false)} className="text-red-500 hover:bg-red-50 p-2 rounded"><LogOut className="w-5 h-5" /></button>
                            </div>
                        </header>
                        <main className="flex-1 overflow-y-auto bg-gray-50">{renderContent()}</main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
